// ЁЯУБ server.js
import express from 'express';
import dotenv from 'dotenv';
import path from 'path';
import { fileURLToPath } from 'url';
import bodyParser from 'body-parser';
import cors from 'cors'; // Angular Defult PORT 4200 , Nodejs Server Port Defult 3000/8000 , browser did no't understand 
import ejs from 'ejs'; // HTML view template
import puppeteer from 'puppeteer'; // HTML ржерзЗржХрзЗ PDF convert ржХрж░рж╛рж░ ржЬржирзНржп
import criminalRoutes from './routes/criminal.routes.js';
// CORS ржХрзЗржи ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣рзЯ?

// рж╕рж╣ржЬ ржХржерж╛рзЯ, CORS рж╣рж▓рзЛ ржПржХржЯрж┐ ржирж┐рж░рж╛ржкрждрзНрждрж╛ ржмрзНржпржмрж╕рзНржерж╛ ржпрж╛ ржмрзНрж░рж╛ржЙржЬрж╛рж░ржХрзЗ ржмрзЛржЭрж╛рзЯ ржпрзЗ ржЕржирзНржп ржПржХржЯрж┐ ржбрзЛржорзЗржЗржи ржерзЗржХрзЗ ржЖрж╕рж╛ ржЕржирзБрж░рзЛржз ржЧрзНрж░рж╣ржг ржХрж░рж╛ ржирж┐рж░рж╛ржкржжред
// ржпржжрж┐ ржЖржкржирж╛рж░ Angular ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржи localhost:4200-ржП ржЪрж▓рзЗ ржПржмржВ Node.js рж╕рж╛рж░рзНржнрж╛рж░ localhost:3000-ржП ржЪрж▓рзЗ, рждрж╛рж╣рж▓рзЗ ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗрж░ ржХрж╛ржЫрзЗ ржПржЗ ржжрзБржЯрж┐ ржЖрж▓рж╛ржжрж╛ ржбрзЛржорзЗржЗржи рж╣рж┐рж╕рзЗржмрзЗ ржмрж┐ржмрзЗржЪрж┐ржд рж╣рзЯред
// ржмрзНрж░рж╛ржЙржЬрж╛рж░рзЗрж░ ржПржХржЯрж┐ ржирж┐рзЯржо ржЖржЫрзЗ: "ржПржХ ржбрзЛржорзЗржЗржирзЗрж░ ржХрзЛржб ржЕржирзНржп ржбрзЛржорзЗржЗржирзЗрж░ рж╕рж╛рж░рзНржнрж╛рж░ржХрзЗ рж╕рж░рж╛рж╕рж░рж┐ ржбрзЗржЯрж╛ ржЪрж╛ржЗрждрзЗ ржкрж╛рж░ржмрзЗ ржирж╛, ржпржжрж┐ ржирж╛ рж╕рж╛рж░рзНржнрж╛рж░ ржЕржирзБржорждрж┐ ржжрзЗрзЯред"
// CORS ржПрж░ ржХрж╛ржЬ рж╣рж▓рзЛ: Node.js рж╕рж╛рж░рзНржнрж╛рж░рзЗ cors ржкрзНржпрж╛ржХрзЗржЬ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж▓рзЗ, ржЖржкржирж┐ рж╕рж╛рж░рзНржнрж╛рж░ржХрзЗ ржмрж▓рзЗ ржжрзЗржи ржпрзЗ "рж╣рзНржпрж╛ржБ, localhost:4200 ржерзЗржХрзЗ ржЖрж╕рж╛ ржЕржирзБрж░рзЛржзржЧрзБрж▓рзЛ ржЖржорж╛рж░ ржЬржирзНржп ржарж┐ржХ ржЖржЫрзЗред 
// рждрзБржорж┐ рж╕рзЗржЧрзБрж▓рзЛржХрзЗ ржЧрзНрж░рж╣ржг ржХрж░рждрзЗ ржкрж╛рж░рзЛред"
// ржПржЗ ржЕржирзБржорждрж┐рж░ ржХрж╛рж░ржгрзЗ ржмрзНрж░рж╛ржЙржЬрж╛рж░ ржЖрж░ ржирж┐рж░рж╛ржкрждрзНрждрж╛ рж╕ржВржХрзНрж░рж╛ржирзНржд ржмрж╛ржзрж╛ ржжрзЗрзЯ ржирж╛, ржПржмржВ Angular ржЕрзНржпрж╛ржкрзНрж▓рж┐ржХрзЗрж╢ржиржЯрж┐ Node.js рж╕рж╛рж░рзНржнрж╛рж░ ржерзЗржХрзЗ ржбрзЗржЯрж╛ ржЖржирждрзЗ ржкрж╛рж░рзЗред

dotenv.config();
const app = express();
app.use(cors());
app.use(bodyParser.urlencoded({ extended: true }));
app.use(bodyParser.json());

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));

// тЬЕ ржбрзЗржЯрж╛ржмрзЗрж╕ рж╕ржВржпрзЛржЧ ржлрж╛ржВрж╢ржи
async function connectToDatabase() {
  try {
    const connection = await mysql.createConnection({
      host: process.env.MYSQL_HOST, // тЬЕ рж░рзЗрж▓ржУржпрж╝рзЗрж░ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗрж░ ржирж╛ржо ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
      user: process.env.MYSQL_USER, // тЬЕ рж░рзЗрж▓ржУржпрж╝рзЗрж░ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗрж░ ржирж╛ржо ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
      password: process.env.MYSQL_PASSWORD, // тЬЕ рж░рзЗрж▓ржУржпрж╝рзЗрж░ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗрж░ ржирж╛ржо ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
      database: process.env.MYSQL_DATABASE, // тЬЕ рж░рзЗрж▓ржУржпрж╝рзЗрж░ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗрж░ ржирж╛ржо ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
      port: process.env.MYSQL_PORT, // тЬЕ рж░рзЗрж▓ржУржпрж╝рзЗрж░ ржПржиржнрж╛ржпрж╝рж░ржиржорзЗржирзНржЯ ржнрзЗрж░рж┐ржпрж╝рзЗржмрж▓рзЗрж░ ржирж╛ржо ржмрзНржпржмрж╣рж╛рж░ ржХрж░рж╛ рж╣ржпрж╝рзЗржЫрзЗ
    });
    console.log('тЬЕ Connected to MySQL Database!');
    return connection;
  } catch (error) {
    console.error('тЭМ Failed to connect to database:', error);
    process.exit(1);
  }
}

// тЬЕ рж╕рж╛рж░рзНржнрж╛рж░ ржЪрж╛рж▓рзБ ржХрж░рж╛рж░ ржЖржЧрзЗ ржбрзЗржЯрж╛ржмрзЗрж╕ рж╕ржВржпрзЛржЧ рж╕рзНржерж╛ржкржи
async function startServer() {
  await connectToDatabase();
  
  // тЬЕ Connect Routes
  app.use('/api/criminals', criminalRoutes);

  const port = process.env.PORT || 3000;
  app.listen(port, () => {
    console.log(`ЁЯЪА Server running on http://localhost:${port}`);
  });
}

// тЬЕ рж╕рж╛рж░рзНржнрж╛рж░ рж╢рзБрж░рзБ ржХрж░рж╛
startServer();
